version: '3.5'
services:
    # Load Balancer (NginX)
    nerd_lb:
        container_name: 'nerd-lb'
        image: nerd-lb:latest
        restart: always
        volumes: 
            - './load-balancer/certs:/etc/letsencrypt'
        depends_on: 
            - 'nerd_portal'
        build:
          context: ./load-balancer/
        ports:
          - '80:80'
          - '443:443'
    # Database (MySQL)
    nerd_db:
        container_name: 'nerd-db'
        image: nerd-db:latest
        build:
            context: ./database/
        command: --default-authentication-plugin=mysql_native_password
        restart: always
        ports:
        - '3306:3306'
        environment:
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
            MYSQL_USER: ${DB_USER}
            MYSQL_PASSWORD: ${DB_PASS}
            MYSQL_DATABASE: ${DB_NAME}
    # Main API / Portal for NERD (React / Express)
    nerd_portal:
        container_name: 'nerd-portal'
        image: nerd:latest
        restart: always
        build:
            context: ./server/
        depends_on: 
            - 'nerd_db'
        ports:
        - '8081:8081'
        environment:
            PORT: 8081
            DB_HOST: ${DB_HOST}
            DB_USER: ${DB_USER}
            DB_PASS: ${DB_PASS}
            DB_NAME: ${DB_NAME}
# Network to Communicate
networks:
    default:
        name: nerd-network